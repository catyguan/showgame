<html>
<head>
<meta charset="utf-8" />
<title>home</title>
</head>
<body>
[Dungelot Main] - 
<button onclick="reloadView()">ReloadView</button>
<br>
<div id="info"></div>
<div id="map">
</div>

<script>
contentManager = {
	Init : function(viewData) {
		this.InitView(viewData);
		this.UpdateView(viewData);
	},
	Update : function(viewData) {
		console.log("doUpdate!!!!")
		console.log(viewData)
		this.UpdateView(viewData);
	},
	Close : function() {

	},
	CellId : function(x,y) {
		return "c_"+x+"_"+y;
	},
	InitView : function(viewData) {
		var w = viewData.w;
		var h = viewData.h;
		var html = "";
		html += "<table>";
		for (var y = 0; y < h; y++) {
			html += "<tr>";
			for (var x = 0; x < w; x++) {
				html += "<td id='"+this.CellId(x+1,y+1)+"' width=64 height=64 align='center' valign='middle'></td>";
			}
			html += "</tr>";
		}
		html += "</table>";
		$('#map').html(html)
	},
	UpdateView : function(viewData) {
		var th = this
		this.sid = viewData.sid;		
		processEvents(viewData.events, this.handleEvents, function() {
			th.BuildInfo(viewData.a);
			th.BuildMap(viewData.map);
		});		
	},
	GetTips : function(cell) {		
		if(cell.t=="et") {
			return "入口。从这里出发探索地牢吧";
		}
		if(cell.t=="ro") {
			return "碍事的石头";
		}
		if(cell.t=="out") {
			return "进入下一个地牢的通道";
		}
		if(cell.t=="lock") {
			return "关闭的通道大门。去寻找钥匙吧";
		}
		return "";
	},
	BuildInfo : function(info) {
		if(!info)return;
		var html = "";
		html += "地牢:"+info.level+"/"+info.maxlevel;
		html += "<br>";
		html += "力量:"+info.Power+";";
		$('#info').html(html)
	},
	BuildMap : function(map) {
		if(map)	{
			for (var i = 0; i < map.length; i++) {
				var cell = map[i];
				var x = cell.x;
				var y = cell.y;
				var html = "";
				var img = "hide_1";
				var clickable = cell.c?cell.c==1:false;
				var block = cell.b && cell.b>0;
				var light = cell.l && cell.l==1;
				var alt = "";
				if(cell.h>0) {
					img = "hide_"+cell.h;
					if(light) {
						clickable = cell.h!=2;
						alt = "点击探索";		
					}
				} else {
					img = "cell_"+cell.t;
					if(cell.t=="mo") {
						img = img + "_" + cell.mt;
					}
				}
				var css = "";
				var border = 0;
				if(clickable) {
					if(block) {
						css = "style='border-color:#FF0000'";
						border = 3;
					} else {
						html += "<a href='#' onclick='return contentManager.doClick("+x+","+y+")'>";
					}
				}
				var size = 64-2*border;
				if(alt=="")alt = this.GetTips(cell);
				if(alt!="")alt = " title = '"+alt+"'";
				html += "<img src='images/"+img+".png' width="+size+" height="+size+" border="+border+" "+css+alt+"/>";
				if(clickable && !block) {
					html += "</a>";
				}
				var co = $('#'+this.CellId(x,y));
				co.html(html);
				co.css("opacity", light?1:0.6);
			}
		}
	},
	handleEvents : function(ev, nextf) {
		if(ev.t=="msg") {
			alert(ev.text);
		}
		nextf();
	},
	doClick : function(x, y) {
		var cb = function(data) {
			// console.log("here");
			return true;
		}
		var p = {cmd:"click", x:x, y:y};
		doUIProcess(this.sid, p, cb);
		return false;
	},
	ISEnd : false
}
</script>

</body>
</html>
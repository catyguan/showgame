<html>
<head>
<meta charset="utf-8" />
<title>Combat</title>
</head>
<body>
<div>
	<table>
		<tr>
			<td>
				<table border="1">
					<tr>
						<td width="120" height="65" id="map_2_4">&nbsp;	</td>
						<td width="120" height="65" id="map_2_5">&nbsp;</td>
						<td width="120" height="65" id="map_2_6">&nbsp;</td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_2_1">&nbsp;</td>
						<td width="120" height="65" id="map_2_2">&nbsp;</td>
						<td width="120" height="65" id="map_2_3">&nbsp;</td>
					</tr>
					<tr>
						<td colspan="3" bgcolor="blue"></td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_1_1">&nbsp;</td>
						<td width="120" height="65" id="map_1_2">&nbsp;</td>
						<td width="120" height="65" id="map_1_3">&nbsp;</td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_1_4">&nbsp;</td>
						<td width="120" height="65" id="map_1_5">&nbsp;</td>
						<td width="120" height="65" id="map_1_6">&nbsp;</td>
					</tr>
				</table>
			</td>
			<td id="chinfo" valign="top">&nbsp;</td>
		</tr>
	</table>
</div>
<hr>
<table border="1">
<tr><td id="ginfo" width="320" valign="top">
</td><td id="msgdiv" valign="top">
</td></tr>
</table>

<script>
contentManager = {
	eid : 0,
	selected : "",
	messages : [],

	Init : function(viewData) {
		contentManager.DoProcess(null, 0);		
	},
	Update : function(viewData) {
		contentManager.UpdateView(viewData);
	},
	DoProcess : function(cmd, sid) {
		doUIProcess(sid, cmd, function(rs) {
			contentManager.EvalEvent(rs.result);
			contentManager.UpdateView(rs.data);
		});
	},
	SkillDesc : function(skdesc, skprop1, skprop2, skprop3) {
		var str = theText(skdesc);
		var word = "";
		var mword = false;
		var nstr = "";
		for (var i = 0; i <str.length; i++) {
			var s = str[i];
			if(!mword) {
				if(s=="{") {
					mword = true;
					word = "";
					continue;
				}
				nstr += s;
			} else {
				if(s=="}") {
					mword = false;
					var w = "";
					w = skprop1[word];
					if(!w && skprop2) {
						w = skprop2[word];
						if(!w && skprop3) {
							w = skprop3[word];
						}
					}
					nstr += w;
					continue;
				}
				word += s;
			}
		}
		return nstr;
	},
	EventText : function(ev) {
		var msg = "";
		for(var key in ev){
 			msg += key+"="+ev[key]+"; ";
		}
		return msg;
	},
	FocusOn : function(cid, focus) {
		if(cid!=contentManager.selected) {
			var oid = contentManager.selected;
			var ochobj = contentManager.viewData.chars[oid];
			if(ochobj) {
				var ochpro = contentManager.viewProfile.chars[oid];
				var otid = ochobj.team;
				var opos = ochobj.pos;
				$( "#tab_"+otid+"_"+opos ).css("background-color", "");
				$( "#oth_"+oid ).css("border", "");
			}
			contentManager.selected = "";
			$( "#chinfo" ).html("");
		}

		if(!focus) {
			return;
		}

		var chobj = contentManager.viewData.chars[cid];
		if(!chobj) {
			return;
		}
		var chpro = contentManager.viewProfile.chars[cid];
		var tid = chobj.team;
		var pos = chobj.pos;

		if(!focus)return;
		$( "#tab_"+tid+"_"+pos ).css("background-color", "#E6E6FA");
		$( "#oth_"+cid ).css("border", "1px #FF0000 solid");
		contentManager.selected = cid;

		// show detail
		var html = "";
		html += theText(chpro.title)+"<br>";
		html += "HP:"+chobj.HP+",";
		html += "ATK:"+chobj.ATK+",";
		html += "DEF:"+chobj.DEF+",";
		html += "SHD:"+chobj.SHD+",";
		html += "AGI:"+chobj.AGI+",";
		if(tid==1) {
			html += "SKL:"+chobj.SKL+",";
		}
		if(chobj.effects && chobj.effects.length>0) {
			html += "<br>";
			html += "[效果]";
			for (var i = 0; i < chobj.effects.length; i++) {
				var efi = chobj.effects[i];
				var ef = contentManager.viewProfile.effects[efi.id];

				html += "<br>";				
				html += theText(ef.title);
				if(efi.LAST>0) {
					html+="("+efi.LAST+")";
				}
				html += " - "+contentManager.SkillDesc(ef.desc, efi, chobj, chpro);
			};
		}
		if(chobj.skills) {
			html += "<br>";
			html += "[技能]";
			for (var i = 0; i < chobj.skills.length; i++) {
				var ski = chobj.skills[i];
				var sk = contentManager.viewProfile.skills[ski.id];

				html += "<br>";
				html += theText(sk.title)+" - ";
				html += contentManager.SkillDesc(sk.desc, sk, chobj, chpro);
			}
		}
		html += "<br>"
		$( "#chinfo" ).html(html);
	},
	UpdateView : function(viewData) {

	},
	BuildView : function(data) {
		var mpos = {};
		var viewData = data.view
		contentManager.viewProfile = data.profile;		

		contentManager.viewData = viewData;		

		var focusId = "";
		var ostr = "";
		var mui = "";
		for (var i = 0; i< viewData.aorder.length; i++) {
			var chid = viewData.aorder[i];
			var chobj = viewData.chars[chid];
			if(chobj==null)continue;
			var chpro = contentManager.viewProfile.chars[chid];
			var tid = chobj.team;
			var pos = chobj.pos;
			mpos["p"+tid+"_"+pos] = true;

			var html = "";
			var tabcss = "";
			if(i==0) {
				tabcss = "border: 1px solid #FF9900;"
			}
			html += "<table id='tab_"+tid+"_"+pos+"' style='"+tabcss+"'><tr>";
			html += "<td>";
			html += "<img src='"+chpro.pic+"' width=60 height=60 onclick=\"contentManager.SelectChar('"+chobj.id+"')\">";
			html += "</td><td>";
			html += "HP:"+chobj.HP+"<br>";
			html += "ATK:"+chobj.ATK+"<br>";
			html += "SHD:"+chobj.SHD+"<br>";
			html += "</td>";
			html += "</tr></table>"
			$( "#map_"+tid+"_"+pos ).html(html);

			if(contentManager.selected==chobj.id) {
				focusId = chobj.id;				
			}

			ostr +="<img id='oth_"+chobj.id+"' src='"+chpro.pic+"' width=16 height=16 onclick=\"contentManager.SelectChar('"+chobj.id+"')\" title='"+theText(chpro.title)+"''>";

			if(i==0 && tid==1) {
				mui += "<table><tr><td>";
				mui += "<img src='"+chpro.pic+"' width=60 height=60>";
				mui += "</td><td>";
				for (var j = 0; j < chobj.skills.length; j++) {
					var ski = chobj.skills[j];
					var sk = contentManager.viewProfile.skills[ski.id];
					if(j!=0)mui += "<br>";
					mui += "<button onclick=\"contentManager.SelectSkill('"+chobj.id+"','"+ski.id+"')\">"+theText(sk.title)+" AP:"+sk.AP+" CD:"+sk.CD+"</button> ";
				}
				mui += "</td></tr></table>";
			}
		}

		html = "";
		html += "回合："+viewData.turn+" AP:"+viewData.APS+" "+ostr;
		if(mui!="") {
			html += "<br>"+mui;
		}

		$( "#ginfo" ).html(html);

		contentManager.FocusOn(focusId, focusId!="");

		if(viewData.events) {
			for (var i = 0; i < viewData.events.length; i++) {
				var ev = viewData.events[i];
				var msg = contentManager.EventText(ev)
				contentManager.ShowMessage(msg);
			}			
		}
	},
	ShowMessage : function(msg, iserr) {
		var mbox = contentManager.messages;
		mbox.push({t:new Date(), m:msg,err:iserr});
		if(mbox.length>15) {
			mbox.shift();
		}
		var html = "";
		for (var i = mbox.length - 1; i >= 0; i--) {
			var mi = mbox[i];
			if(html!="") {
				html += "<br>";
			}
			html += mi.t.Format("yyyy-MM-dd hh:mm:ss ");
			if(mi.err) {
				html += "<font color=red>"+theText(mi.m)+"</font>";
			} else {
				html += theText(mi.m);
			}
		};
		$( "#msgdiv" ).html(html);
	},
	Close : function() {

	},
	SelectChar : function(cid) {
		if(cid==contentManager.selected) {
			contentManager.FocusOn("", false);
		} else {
			contentManager.FocusOn(cid, true);
		}
	},
	SelectSkill : function(cid, skid) {
		var sid = contentManager.selected;
		var sk = contentManager.viewProfile.skills[skid];
		// check target
		if(sk.target) {
			var me = contentManager.viewData.chars[cid];
			if(sk.target=="one") {
				if(sid=="") {
					contentManager.ShowMessage("请选择一个敌方目标", true);
					return;
				}				
				var sobj = contentManager.viewData.chars[sid];
				if(sobj.team==me.team) {
					contentManager.ShowMessage("该技能需要对敌方使用", true);
					return;
				}
			}
		}
		contentManager.DoProcess({"skill":skid, "me":cid, "target":contentManager.selected}, contentManager.eid);
	},
	EvalEvent : function(elist) {
		if(!elist)return;
		for (var i = 0; i < elist.length; i++) {
			var ev = elist[i];
			if(ev.id) {
				contentManager.eid = ev.id;
			}
			if(ev.k=="init") {
				contentManager.BuildView(ev.data);
				contentManager.EvalEvent([{k: "p"}]);
			} else if(ev.k=="err") {
				contentManager.ShowMessage(ev.msg, true);
			} else if(ev.k=="msg") {
				contentManager.ShowMessage(ev.msg);
			} else if(ev.k=="p") {
				contentManager.timer = setTimeout(function() {
					if(contentManager.EvalEvent) {
						contentManager.DoProcess(null, contentManager.eid);
					}
				}, 500)
			} else if(ev.k=="cmd") {
				// wait user command
				contentManager.ShowMessage("请输入指令");
			} else {
				console.log("unknow event", ev);
			}
		};
	}
}
</script>

</body>
</html>
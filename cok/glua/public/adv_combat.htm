<html>
<head>
<meta charset="utf-8" />
<title>Combat</title>
</head>
<body>
<div>
	<table>
		<tr>
			<td>
				<table border="1">
					<tr>
						<td width="120" height="65"><div id="map_2_4">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_2_5">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_2_6">&nbsp;</div></td>
					</tr>
					<tr>
						<td width="120" height="65"><div  id="map_2_1">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_2_2">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_2_3">&nbsp;</div></td>
					</tr>
					<tr>
						<td colspan="3" bgcolor="blue"></td>
					</tr>
					<tr>
						<td width="120" height="65"><div  id="map_1_1">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_1_2">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_1_3">&nbsp;</div></td>
					</tr>
					<tr>
						<td width="120" height="65"><div  id="map_1_4">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_1_5">&nbsp;</div></td>
						<td width="120" height="65"><div  id="map_1_6">&nbsp;</div></td>
					</tr>
				</table>
			</td>
			<td id="chinfo" valign="top">&nbsp;</td>
		</tr>
	</table>
</div>
<hr>
<table border="1">
<tr><td id="ginfo" width="320" valign="top">
</td><td id="msgdiv" valign="top">
</td></tr>
</table>

<script>
contentManager = {
	eid : 0,
	selected : "",
	messages : [],
	processing : false,
	processCommand : null,
	colors : [[],[]],

	Init : function(viewData) {
		for (var t = 0; t < 2; t++) {
			var tc = contentManager.colors[t];
			for (var p = 0; p < 6; p++) {
				tc[p] = "";
			}
		}
		contentManager.DoProcess();
	},
	Update : function(viewData) {
		contentManager.UpdateView(viewData);
	},
	DoProcess : function() {
		if(contentManager.processing) {
			return
		}
		contentManager.processing = true;
		var cmd = null;
		if(contentManager.processCommand!=null) {
			cmd = contentManager.processCommand;
			contentManager.processCommand = null;
		}
		doUIProcess(contentManager.eid, cmd, function(rs) {
			contentManager.processing = false;
			contentManager.EvalEvent(rs.result);
			contentManager.UpdateView(rs.data);
		});
	},
	NextProcess : function(cmd) {
		contentManager.processCommand = cmd;
	},
	SpellEnable : function(spi) {
		if(spi.CD>0) {
			return false;
		}
		if(spi.num<=0) {
			return false;
		}
		return true;
	},
	EventText : function(ev) {
		var msg = "";
		for(var key in ev){
 			msg += key+"="+ev[key]+"; ";
		}
		return msg;
	},
	HPText : function(c, m, s) {
		var clr = "#267F00";
		if(c<m*0.333) {
			clr = "#FF0000";
		} else if(c<m*0.666) {
			clr = "#FF6A00";
		}
		return "<font color='"+clr+"'>"+(s?"":c+"/")+(c*100/m).toFixed(2)+"%</font>";
	},
	DescText : function(skdesc, skprop1, skprop2, skprop3) {
		var str = theText(skdesc);
		var word = "";
		var mword = false;
		var nstr = "";
		for (var i = 0; i <str.length; i++) {
			var s = str[i];
			if(!mword) {
				if(s=="{") {
					mword = true;
					word = "";
					continue;
				}
				nstr += s;
			} else {
				if(s=="}") {
					mword = false;
					var w = "";
					w = skprop1[word];
					if(!w && skprop2) {
						w = skprop2[word];
						if(!w && skprop3) {
							w = skprop3[word];
						}
					}
					nstr += w;
					continue;
				}
				word += s;
			}
		}
		return nstr;
	},
	FocusOn : function(cid, focus) {
		if(cid!=contentManager.selected) {
			var oid = contentManager.selected;
			var ochobj = contentManager.viewData.chars[oid];
			if(ochobj) {
				var ochpro = contentManager.viewProfile.chars[oid];
				var otid = ochobj.team;
				var opos = ochobj.pos;
				$( "#tab_"+otid+"_"+opos ).css("background-color", "");
			}
			contentManager.selected = "";
			$( "#chinfo" ).html("");
		}

		if(!focus) {
			return;
		}

		var chobj = contentManager.viewData.chars[cid];
		if(!chobj) {
			return;
		}
		var chpro = contentManager.viewProfile.chars[cid];
		var tid = chobj.team;
		var pos = chobj.pos;

		if(!focus)return;
		$( "#tab_"+tid+"_"+pos ).css("background-color", "#E6E6FA");
		contentManager.selected = cid;

		// show detail
		var html = "";		
		html += theText(chobj.title)+"<br>";
		html += "LEVEL:"+chobj.level+"<br>";
		html += "HP:"+contentManager.HPText(chobj.HP, chobj.MAXHP)+",";		
		if(chobj.effects && chobj.effects.length>0) {
			html += "<br>";
			html += "[效果]";
			for (var i = 0; i < chobj.effects.length; i++) {
				var efi = chobj.effects[i];
				var ef = contentManager.viewProfile.effects[efi.id];

				html += "<br>";	
				html += "<img src='"+ef.pic+"' width=24>";
				html += theText(ef.title);
				if(efi.LAST>0) {
					html+="("+efi.LAST+")";
				}
				html += " - "+contentManager.DescText(ef.desc, efi, chobj, chpro);
			};
		}
		html += "<br>"
		$( "#chinfo" ).html(html);
	},
	UpdateView : function(viewData) {

	},
	SetColor : function(t, p, c, rc) {
		var old = contentManager.colors[t-1][p-1];
		if(rc!="" && old!=rc)return false;
		contentManager.colors[t-1][p-1] = c;
		return true;
	},
	BuildColors : function() {
		for (var t = 0; t < 2; t++) {
			var tc = contentManager.colors[t];
			for (var p = 0; p < 6; p++) {
				var c = tc[p];
				var team = t+1;
				var pos = p+1;
				var css = "";
				if(c!="")css="1px solid "+c;
				$('#map_'+team+'_'+pos).css('border', css);
			}
		}
	},
	BuildSpells : function() {
		var viewData = contentManager.viewData;
		contentManager.viewData = viewData;		
		var html = "";
		for (var spid in viewData.spells) {
			var sp = viewData.spells[spid];
			var spp = contentManager.viewProfile.spells[spid];
			var en = "";
			var cd = "";
			if(!contentManager.SpellEnable(sp)) {
				en = "disabled";
				if(sp.CD>0) {
					cd = " CD:"+sp.CD;
				}
			}
			html +="<br><button onclick=\"contentManager.SelectSpell('"+sp.id+"')\" "+en+">"+theText(spp.title)+"("+sp.num+")"+cd+"</button>"+theText(spp.desc);
		}
		return html;
	},
	InitView : function(data) {
		contentManager.viewProfile = data.profile;
		contentManager.viewData = data.view;
		contentManager.BuildView();		
	},
	BuildView : function() {
		var mpos = {};
		var viewData = contentManager.viewData;

		for (var i = 1; i <= 2; i++) {
			for (var j = 1; j <= 6; j++) {
				$( "#map_"+i+"_"+j ).html("&nbsp;");
			}
		};

		var focusId = "";
		for(var chid in viewData.chars) {
			var chobj = viewData.chars[chid];
			if(chobj==null)continue;
			var chpro = contentManager.viewProfile.chars[chid];
			var tid = chobj.team;
			var pos = chobj.pos;
			mpos["p"+tid+"_"+pos] = true;

			var html = "";
			var tabcss = "";
			html += "<table id='tab_"+tid+"_"+pos+"'><tr>";
			html += "<td>";
			html += "<img src='"+chpro.pic+"' width=60 height=60 onclick=\"contentManager.SelectChar('"+chobj.id+"')\">";
			html += "</td><td>";
			html += "LEVEL:"+chobj.level+"<br>";
			html += "HP:"+contentManager.HPText(chobj.HP, chobj.MAXHP, true)+"<br>";
			for (var j = 0; j < chobj.effects.length; j++) {
				var efi = chobj.effects[j];
				var efp = contentManager.viewProfile.effects[efi.id];
				var eftext = theText(efp.title);				
				if(efi.LAST>0) {
					eftext+="("+efi.LAST+")";
				}				
				html += "<img src='"+efp.pic+"' width=24 title='"+eftext+"'>";
			};
			html += "</td>";
			html += "</tr></table>"
			$( "#map_"+tid+"_"+pos ).html(html);

			if(contentManager.selected==chobj.id) {
				focusId = chobj.id;				
			}
		}
		contentManager.BuildColors();

		html = "";
		if(viewData.turn>0) {
			html += "行动:<span id='turndiv'>"+viewData.turn+"</span> <span id='spelldiv'>"+contentManager.BuildSpells()+"</span><br>";
		}

		$( "#ginfo" ).html(html);

		contentManager.FocusOn(focusId, focusId!="");

		if(viewData.events) {
			for (var i = 0; i < viewData.events.length; i++) {
				var ev = viewData.events[i];
				var msg = contentManager.EventText(ev)
				contentManager.ShowMessage(msg);
			}			
		}
	},
	ShowMessage : function(msg, iserr) {
		var mbox = contentManager.messages;
		mbox.push({t:new Date(), m:msg,err:iserr});
		if(mbox.length>15) {
			mbox.shift();
		}
		var html = "";
		for (var i = mbox.length - 1; i >= 0; i--) {
			var mi = mbox[i];
			if(html!="") {
				html += "<br>";
			}
			html += mi.t.Format("yyyy-MM-dd hh:mm:ss ");
			if(mi.err) {
				html += "<font color=red>"+theText(mi.m)+"</font>";
			} else {
				html += theText(mi.m);
			}
		};
		$( "#msgdiv" ).html(html);
	},
	Close : function() {

	},
	SelectChar : function(cid) {
		if(cid==contentManager.selected) {
			contentManager.FocusOn("", false);
		} else {
			contentManager.FocusOn(cid, true);
		}
	},
	SelectSpell : function(spid) {
		var sp = contentManager.viewData.spells[spid];
		if(contentManager.SpellEnable(sp)) {
			var p = {"act":"spell", "spellId": spid};
			contentManager.NextProcess(p);	
		}		
	},
	ReloadChar : function(cid, cb) {
		doUIInvoke("LoadChar", {id:cid}, function(rs) {
			if(rs.char) {
				contentManager.viewData.chars[cid] = rs.char;
			}
			cb();
		});		
	},
	EvalEvent : function(elist) {
		contentManager._evalEvent(elist, 0, 0);
	},
	_invokeEvent : function(ev, nextf) {
		if(ev.id) {
			contentManager.eid = ev.id;
		}
		if(ev.k=="init") {
			contentManager.InitView(ev.data);				
			contentManager.EvalEvent([{k: "nextc"}]);
		} else if(ev.k=="err") {
			contentManager.ShowMessage(ev.msg, true);
		} else if(ev.k=="msg") {
			contentManager.ShowMessage(ev.msg);
		} else if(ev.k=="turn") {
			contentManager.viewData.turn = ev.v;
			contentManager.BuildView();
			$("#turndiv").html(ev.v);
		} else if(ev.k=="nextc") {
			setTimeout(function() {
				if(contentManager.EvalEvent) {					
					contentManager.DoProcess(null, contentManager.eid);
				}
			}, 500);			
		} else if(ev.k=="char") {
			contentManager.viewData.chars[ev.MID] = ev.data;
			contentManager.BuildView();
		} else if(ev.k=="spell") {
			contentManager.viewData.spells[ev.SID] = ev.data;
			var html = contentManager.BuildSpells();
			$('#spelldiv').html(html);
		} else if(ev.k=="die") {
			contentManager.viewData.chars[ev.MID] = null;
			contentManager.BuildView();
		} else if(ev.k=="end") {
			contentManager.ShowMessage("end, winner is "+ev.winner, true);
		} else if(ev.k=="skill" || ev.k=="usespell") {
			var msg = "";
			var skd = {};
			var clset = [];
			if(ev.uik=="SkillDef") {
				var ch = contentManager.viewData.chars[ev.MID];
				msg = "::{TITLE}采用防御姿势";
				skd.TITLE = ch.title;				
				clset[0] = {team:ch.team, pos:ch.pos, c:"blue"};
			}
			if(ev.uik=="SpellHeal") {
				msg = "::激活恢复法术";
				for(var cid in contentManager.viewData.chars) {
					var ch = contentManager.viewData.chars[cid];
					if(ch.team==1) {
						clset[clset.length] = {team:ch.team, pos:ch.pos, c:"green"};	
					}
				}
			}
			if(ev.uik=="SkillAttack") {
				var ch = contentManager.viewData.chars[ev.MID];
				var ch2 = contentManager.viewData.chars[ev.TID];
				skd.TITLE = theText(ch.title);
				skd.TITLE2 = theText(ch2.title);
				clset[0] = {team:ch.team, pos:ch.pos, c:"blue"};
				clset[1] = {team:ch2.team, pos:ch2.pos, c:"red"};

				if(ev.info.hited) {
					msg = "::{TITLE}攻击{TITLE2}，造成{DMG}点伤害";
					skd.DMG = ev.info.damage;
				} else {
					msg = "::{TITLE}攻击{TITLE2}，但未命中";
				}				
			}
			if(ev.uik=="wait") {
				var ch = contentManager.viewData.chars[ev.MID];
				msg = "::{TITLE}待机";
				skd.TITLE = ch.title;
			}
			if(clset.length>0) {
				for (var i = 0; i < clset.length; i++) {
					var cl = clset[i];
					if(contentManager.SetColor(cl.team, cl.pos, cl.c, "")) {
						f = function(cl) {
							setTimeout(function() {
								contentManager.SetColor(cl.team, cl.pos, "", cl.c);
							}, 350);
						};
						f(cl);
					}
				}
			}
			var bdone = false;			
			if(ev.refresh && ev.refresh.length>0) {
				for (var i = 0; i < ev.refresh.length; i++) {
					var rinfo = ev.refresh[i]
					contentManager.viewData.chars[rinfo.id] = rinfo.data;				
				};
				bdone = true;
				contentManager.BuildView();
			}
			if(!bdone && clset.length>0) {
				contentManager.BuildColors();
			}
			if(msg) {
				contentManager.ShowMessage(contentManager.DescText(msg, skd));
				return 500;					
			}
		} else {
			console.log("unknow event", ev);
		}
		return 0;
	},
	_evalEvent : function(elist, idx, delay) {
		if(!elist)return;
		if(idx>=elist.length)return;
		var cf = function() {
			for(var i=idx;i<elist.length;i++) {
				var nextf = function() {
					_evalEvent(elist, i+1, 0);
				}
				var ev = elist[i];
				var ndelay = contentManager._invokeEvent(ev, nextf);
				if(ndelay<0) {
					break;
				}
				if(ndelay>0) {
					contentManager._evalEvent(elist, i+1, ndelay);
					break;
				}
			}
		};
		if(delay>0) {
			setTimeout(cf, delay);
		} else {
			cf();
		}
	}
}
</script>

</body>
</html>
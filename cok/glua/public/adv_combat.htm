<html>
<head>
<meta charset="utf-8" />
<title>Combat</title>
</head>
<body>
<div>
	<table>
		<tr>
			<td>
				<table border="1">
					<tr>
						<td width="120" height="65" id="map_2_4">&nbsp;	</td>
						<td width="120" height="65" id="map_2_5">&nbsp;</td>
						<td width="120" height="65" id="map_2_6">&nbsp;</td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_2_1">&nbsp;</td>
						<td width="120" height="65" id="map_2_2">&nbsp;</td>
						<td width="120" height="65" id="map_2_3">&nbsp;</td>
					</tr>
					<tr>
						<td colspan="3" bgcolor="blue"></td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_1_1">&nbsp;</td>
						<td width="120" height="65" id="map_1_2">&nbsp;</td>
						<td width="120" height="65" id="map_1_3">&nbsp;</td>
					</tr>
					<tr>
						<td width="120" height="65" id="map_1_4">&nbsp;</td>
						<td width="120" height="65" id="map_1_5">&nbsp;</td>
						<td width="120" height="65" id="map_1_6">&nbsp;</td>
					</tr>
				</table>
			</td>
			<td id="chinfo" valign="top">&nbsp;</td>
		</tr>
	</table>
</div>
<hr>
<table border="1">
<tr><td id="ginfo" width="320" valign="top">
</td><td id="msgdiv" valign="top">
</td></tr>
</table>

<script>
contentManager = {
	eid : 0,
	selected : "",
	messages : [],

	Init : function(viewData) {
		contentManager.DoProcess(null, 0);		
	},
	Update : function(viewData) {
		contentManager.UpdateView(viewData);
	},
	DoProcess : function(cmd, sid) {
		doUIProcess(sid, cmd, function(rs) {
			contentManager.EvalEvent(rs.result);
			contentManager.UpdateView(rs.data);
		});
	},
	SkillEnable : function(ski) {
		var skp = contentManager.viewProfile.skills[ski.id];
		if(skp.AP && skp.AP>0 && skp.AP>contentManager.viewData.APS) {
			return false;
		}
		if(ski.XCD && ski.XCD>0) {
			return false;
		}
		return true;
	},
	SkillDesc : function(skdesc, skprop1, skprop2, skprop3) {
		var str = theText(skdesc);
		var word = "";
		var mword = false;
		var nstr = "";
		for (var i = 0; i <str.length; i++) {
			var s = str[i];
			if(!mword) {
				if(s=="{") {
					mword = true;
					word = "";
					continue;
				}
				nstr += s;
			} else {
				if(s=="}") {
					mword = false;
					var w = "";
					w = skprop1[word];
					if(!w && skprop2) {
						w = skprop2[word];
						if(!w && skprop3) {
							w = skprop3[word];
						}
					}
					nstr += w;
					continue;
				}
				word += s;
			}
		}
		return nstr;
	},
	EventText : function(ev) {
		var msg = "";
		for(var key in ev){
 			msg += key+"="+ev[key]+"; ";
		}
		return msg;
	},
	FocusOn : function(cid, focus) {
		if(cid!=contentManager.selected) {
			var oid = contentManager.selected;
			var ochobj = contentManager.viewData.chars[oid];
			if(ochobj) {
				var ochpro = contentManager.viewProfile.chars[oid];
				var otid = ochobj.team;
				var opos = ochobj.pos;
				$( "#tab_"+otid+"_"+opos ).css("background-color", "");
				$( "#oth_"+oid ).css("border", "");
			}
			contentManager.selected = "";
			$( "#chinfo" ).html("");
		}

		if(!focus) {
			return;
		}

		var chobj = contentManager.viewData.chars[cid];
		if(!chobj) {
			return;
		}
		var chpro = contentManager.viewProfile.chars[cid];
		var tid = chobj.team;
		var pos = chobj.pos;

		if(!focus)return;
		$( "#tab_"+tid+"_"+pos ).css("background-color", "#E6E6FA");
		$( "#oth_"+cid ).css("border", "1px #FF0000 solid");
		contentManager.selected = cid;

		// show detail
		var html = "";
		html += theText(chpro.title)+"<br>";
		html += "HP:"+chobj.HP+"/"+chobj.MAXHP+",";
		html += "ATK:"+chobj.ATK+",";
		html += "SKL:"+chobj.SKL+",";
		html += "DEF:"+chobj.DEF+"("+(chobj.ARMOR*100).toFixed(2)+"%)"+",";		
		html += "AGI:"+chobj.AGI+"("+(chobj.DODGE*100).toFixed(2)+"%)"+",";
		if(tid==1) {
			html += "APS:"+chobj.APS+",";
		}
		if(chobj.effects && chobj.effects.length>0) {
			html += "<br>";
			html += "[效果]";
			for (var i = 0; i < chobj.effects.length; i++) {
				var efi = chobj.effects[i];
				var ef = contentManager.viewProfile.effects[efi.id];

				html += "<br>";				
				html += theText(ef.title);
				if(efi.LAST>0) {
					html+="("+efi.LAST+")";
				}
				html += " - "+contentManager.SkillDesc(ef.desc, efi, chobj, chpro);
			};
		}
		if(chobj.skills) {
			html += "<br>";
			html += "[技能]";
			for (var i = 0; i < chobj.skills.length; i++) {
				var ski = chobj.skills[i];
				var sk = contentManager.viewProfile.skills[ski.id];

				html += "<br>";
				html += theText(sk.title)+" - ";
				html += contentManager.SkillDesc(sk.desc, sk, chobj, chpro);
			}
		}
		html += "<br>"
		$( "#chinfo" ).html(html);
	},
	UpdateView : function(viewData) {

	},
	BuildOrder : function() {
		var viewData = contentManager.viewData;
		contentManager.viewData = viewData;		
		var ostr = "";
		for (var i = 0; i< viewData.aorder.length; i++) {
			var chid = viewData.aorder[i];
			var chobj = viewData.chars[chid];
			if(chobj==null)continue;
			var chpro = contentManager.viewProfile.chars[chid];

			ostr +="<img id='oth_"+chobj.id+"' src='"+chpro.pic+"' width=16 height=16 onclick=\"contentManager.SelectChar('"+chobj.id+"')\" title='"+theText(chpro.title)+"''>";
			var tabcss="";
			if(i==0) {
				tabcss = "1px solid #FF9900";
			}
			$("#tab_"+chobj.team+"_"+chobj.pos).css("border", tabcss);
		}
		$("#orderdiv").html(ostr);
	},
	InitView : function(data) {
		contentManager.viewProfile = data.profile;
		contentManager.viewData = data.view;
		contentManager.BuildView();		
	},
	BuildView : function() {
		var mpos = {};
		var viewData = contentManager.viewData;

		for (var i = 1; i <= 2; i++) {
			for (var j = 1; j <= 6; j++) {
				$( "#map_"+i+"_"+j ).html("&nbsp;");
			}
		};

		var focusId = "";
		var mui = "";
		for (var i = 0; i< viewData.aorder.length; i++) {
			var chid = viewData.aorder[i];
			var chobj = viewData.chars[chid];
			if(chobj==null)continue;
			var chpro = contentManager.viewProfile.chars[chid];
			var tid = chobj.team;
			var pos = chobj.pos;
			mpos["p"+tid+"_"+pos] = true;

			var html = "";
			var tabcss = "";
			html += "<table id='tab_"+tid+"_"+pos+"'><tr>";
			html += "<td>";
			html += "<img src='"+chpro.pic+"' width=60 height=60 onclick=\"contentManager.SelectChar('"+chobj.id+"')\">";
			html += "</td><td>";
			html += "HP:"+chobj.HP+"<br>";
			html += "P:"+chobj.ATK+"/"+chobj.SKL+"<br>";
			html += "D:"+chobj.DEF+"/"+chobj.AGI+"<br>";
			html += "</td>";
			html += "</tr></table>"
			$( "#map_"+tid+"_"+pos ).html(html);

			if(contentManager.selected==chobj.id) {
				focusId = chobj.id;				
			}

			if(i==0 && tid==1) {
				mui += "<table><tr><td>";
				mui += "<img src='"+chpro.pic+"' width=60 height=60>";
				mui += "</td><td>";
				for (var j = 0; j < chobj.skills.length; j++) {
					var ski = chobj.skills[j];
					var sk = contentManager.viewProfile.skills[ski.id];
					if(j!=0)mui += "<br>";
					var en = "";
					if(!contentManager.SkillEnable(ski)) {
						en = "disabled";
					}					
					var cd = ski.XCD && ski.XCD>0?ski.XCD:sk.CD;
					mui += "<button onclick=\"contentManager.SelectSkill('"+chobj.id+"','"+ski.id+"')\" "+en+">"+theText(sk.title)+" AP:"+sk.AP+" CD:"+cd+"</button>";
				}
				mui += "<br><button onclick=\"contentManager.SelectSkill('"+chobj.id+"','wait')\">待机</button>";
				mui += "</td></tr></table>";
			}
		}

		html = "";
		html += "回合:<span id='turndiv'>"+viewData.turn+"</span> AP:"+viewData.APS+" <span id='orderdiv'></span>";
		if(mui!="") {
			html += "<br>"+mui;
		}

		$( "#ginfo" ).html(html);

		contentManager.BuildOrder()

		contentManager.FocusOn(focusId, focusId!="");

		if(viewData.events) {
			for (var i = 0; i < viewData.events.length; i++) {
				var ev = viewData.events[i];
				var msg = contentManager.EventText(ev)
				contentManager.ShowMessage(msg);
			}			
		}
	},
	ShowMessage : function(msg, iserr) {
		var mbox = contentManager.messages;
		mbox.push({t:new Date(), m:msg,err:iserr});
		if(mbox.length>15) {
			mbox.shift();
		}
		var html = "";
		for (var i = mbox.length - 1; i >= 0; i--) {
			var mi = mbox[i];
			if(html!="") {
				html += "<br>";
			}
			html += mi.t.Format("yyyy-MM-dd hh:mm:ss ");
			if(mi.err) {
				html += "<font color=red>"+theText(mi.m)+"</font>";
			} else {
				html += theText(mi.m);
			}
		};
		$( "#msgdiv" ).html(html);
	},
	Close : function() {

	},
	SelectChar : function(cid) {
		if(cid==contentManager.selected) {
			contentManager.FocusOn("", false);
		} else {
			contentManager.FocusOn(cid, true);
		}
	},
	SelectSkill : function(cid, skid) {
		var sid = contentManager.selected;
		var sk = contentManager.viewProfile.skills[skid];
		var p = {"act":"skill", "skill":skid, "me":cid, "target":sid};
		doUIInvoke("CheckSkill", p, function(rs) {
			if(rs.err) {
				contentManager.ShowMessage(theText(rs.err), true);
				return;
			}
			if(rs.msg) {
				contentManager.ShowMessage(theText(rs.msg), false);	
				return;
			}
			if(!rs.ok) {

			}
			contentManager.DoProcess(p, contentManager.eid);
		});		
	},
	ReloadChar : function(cid, cb) {
		doUIInvoke("LoadChar", {id:cid}, function(rs) {
			if(rs.char) {
				contentManager.viewData.chars[cid] = rs.char;
			}
			cb();
		});		
	},
	EvalEvent : function(elist) {
		contentManager._evalEvent(elist, 0, 0);
	},
	_invokeEvent : function(ev, nextf) {
		if(ev.id) {
			contentManager.eid = ev.id;
		}
		if(ev.k=="init") {
			contentManager.InitView(ev.data);				
			contentManager.EvalEvent([{k: "p"}]);
		} else if(ev.k=="err") {
			contentManager.ShowMessage(ev.msg, true);
		} else if(ev.k=="msg") {
			contentManager.ShowMessage(ev.msg);
		} else if(ev.k=="p") {
			contentManager.timer = setTimeout(function() {
				if(contentManager.EvalEvent) {
					contentManager.DoProcess(null, contentManager.eid);
				}
			}, 500);
		} else if(ev.k=="cmd") {
			// wait user command
			var cid = contentManager.viewData.aorder[0];
			var ch = contentManager.viewData.chars[cid];
			for (var i = 0; i < ch.skills.length; i++) {
				var sk = ch.skills[i];
				if(contentManager.SkillEnable(sk)) {
					contentManager.ShowMessage("请输入指令");
					return 0;		
				}
			}
			contentManager.SelectSkill(cid, "wait");			
		} else if(ev.k=="turn") {
			$("#turndiv").html(ev.v);
		} else if(ev.k=="nextc") {
			var viewData = contentManager.viewData;
			viewData.aorder = ev.a;
			contentManager.BuildView();
			return 500;
		} else if(ev.k=="refresh") {
			contentManager.viewData.chars[ev.id] = ev.data;
			contentManager.BuildView();
		} else if(ev.k=="die") {
			contentManager.viewData.chars[ev.MID] = null;
			contentManager.viewData.aorder = ev.a;
			contentManager.BuildView();
		} else if(ev.k=="end") {
			contentManager.ShowMessage("end, winner is "+ev.winner, true);
		} else if(ev.k=="aps") {
			contentManager.viewData.APS = ev.v;
			contentManager.BuildView();
		} else if(ev.k=="skill") {
			var msg = "";
			var skd = {};
			if(ev.uik=="SkillDef") {
				var ch = contentManager.viewData.chars[ev.MID];
				msg = "::{TITLE}采用防御姿势";
				skd.TITLE = ch.title;
			}
			if(ev.uik=="SkillAttack") {
				var ch = contentManager.viewData.chars[ev.MID];
				var ch2 = contentManager.viewData.chars[ev.TID];
				skd.TITLE = theText(ch.title);
				skd.TITLE2 = theText(ch2.title);

				if(ev.info.hited) {
					msg = "::{TITLE}攻击{TITLE2}，造成{DMG}点伤害";
					skd.DMG = ev.info.damage;
				} else {
					msg = "::{TITLE}攻击{TITLE2}，但未命中";
				}				
			}
			if(ev.uik=="wait") {
				var ch = contentManager.viewData.chars[ev.MID];
				msg = "::{TITLE}待机";
				skd.TITLE = ch.title;
			}
			if(ev.refresh) {
				for (var i = 0; i < ev.refresh.length; i++) {
					var rinfo = ev.refresh[i]
					contentManager.viewData.chars[rinfo.id] = rinfo.data;				
				};
				contentManager.BuildView();
			}
			if(msg) {
				contentManager.ShowMessage(contentManager.SkillDesc(msg, skd));
				return 500;					
			}
		} else {
			console.log("unknow event", ev);
		}
		return 0;
	},
	_evalEvent : function(elist, idx, delay) {
		if(!elist)return;
		if(idx>=elist.length)return;		
		setTimeout(function() {
			var nextf = function() {
				_evalEvent(elist, idx+1, 0);
			}
			var ev = elist[idx];
			var ndelay = contentManager._invokeEvent(ev, nextf);
			if(ndelay>=0) {
				contentManager._evalEvent(elist, idx+1, ndelay);
			}
		}, delay);
	}
}
</script>

</body>
</html>